<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>词义辨析 Quiz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 2em auto;
      padding: 1em;
    }
    .question-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
    }
    .options label {
      display: block;
      margin: 0.5em 0;
    }
    .correct { color: green; }
    .wrong { color: red; }
    button { margin-top: 1em; }
    #stats { margin-top: 1em; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>词义辨析 Quiz</h1>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />
  <div id="quizContainer"></div>
  <div id="stats"></div>

  <script>
    let quizData = [];
    let currentIndex = 0;
    let correctCount = 0;
    let startTime = null;

    function parseExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        localStorage.setItem('quizData', JSON.stringify(json));
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function renderQuestion() {
      if (currentIndex >= quizData.length) {
        document.getElementById('quizContainer').innerHTML = '<h3>已完成！🎉</h3>';
        return;
      }

      const q = quizData[currentIndex];
      const container = document.getElementById('quizContainer');
      container.innerHTML = `
        <div class="question-box">
          <div><strong>题干 ${currentIndex + 1}：</strong> ${q['题干']}</div>
          <div class="options">
            ${['选项A', '选项B', '选项C', '选项D'].map(letter => `
              <label><input type="radio" name="option" value="${letter}" /> ${letter}. ${q[letter]}</label>
            `).join('')}
          </div>
          <button onclick="submitAnswer()">提交</button>
          <button onclick="toggleFavorite(${currentIndex})">⭐ 收藏</button>
          <div id="feedback"></div>
        </div>
      `;
    }

    function submitAnswer() {
      const q = quizData[currentIndex];
      const selected = document.querySelector('input[name="option"]:checked');
      const feedback = document.getElementById('feedback');
      if (!selected) {
        feedback.innerHTML = '<span class="wrong">请选择一个选项。</span>';
        return;
      }
      if (selected.value === q['正确答案']) {
        feedback.innerHTML = '<span class="correct">✅ 正确！</span>';
        correctCount++;
      } else {
        feedback.innerHTML = `<span class="wrong">❌ 错误！正确答案是 ${q['正确答案']}</span>`;
      }
      feedback.innerHTML += `<div>解析：${q['解析'] || '无'}</div>`;
      setTimeout(() => {
        currentIndex++;
        renderQuestion();
        updateStats();
      }, 2000);
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const elapsed = startTime ? (Date.now() - startTime) / 1000 : 0;
      stats.innerHTML = `
        <div>当前进度：${currentIndex}/${quizData.length}</div>
        <div>正确数：${correctCount}</div>
        <div>正确率：${((correctCount / currentIndex) * 100).toFixed(1)}%</div>
        <div>耗时：${elapsed.toFixed(1)} 秒</div>
      `;
    }

    function toggleFavorite(index) {
      let fav = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (!fav.includes(index)) fav.push(index);
      else fav = fav.filter(i => i !== index);
      localStorage.setItem('favorites', JSON.stringify(fav));
      alert(fav.includes(index) ? '已收藏' : '已取消收藏');
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        parseExcel(file, data => {
          quizData = shuffle(data);
          currentIndex = 0;
          correctCount = 0;
          startTime = Date.now();
          renderQuestion();
          updateStats();
        });
      }
    });

    // 自动加载缓存的 quizData（如果有）
    const cached = localStorage.getItem('quizData');
    if (cached) {
      quizData = shuffle(JSON.parse(cached));
      currentIndex = 0;
      correctCount = 0;
      startTime = Date.now();
      renderQuestion();
      updateStats();
    }
  </script>
</body>
</html>
