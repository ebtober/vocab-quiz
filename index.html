<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>刷题系统</title>
  <style>
    body {
      background-color: #FFD1DC;
      font-family: sans-serif;
      padding: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .option {
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .option.correct {
      border-color: green;
      background-color: #c6f6d5;
    }
    .option.wrong {
      border-color: red;
      background-color: #feb2b2;
    }
    #uploadLabel, #controls {
      margin-bottom: 20px;
    }
    button {
      margin-right: 10px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    #timer, #accuracy {
      margin: 10px 0;
    }
    .hidden {
      display: none;
    }
    #explanationBox {
      margin-top: 16px;
      margin-bottom: 16px;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <h1>刷题系统</h1>
  <div id="uploadLabel">
    <input type="file" id="excelFile" accept=".xlsx" />
  </div>
  <div id="controls" class="hidden">
    <div id="timer">用时: 0秒</div>
    <div id="accuracy">正确率: 0%</div>
    <div id="explanationBox"></div>
    <button onclick="nextQuestion()">下一题</button>
    <button onclick="toggleFavorites()">查看收藏册</button>
  </div>
  <div id="questionBox" class="card hidden"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let questions = [];
    let currentIndex = 0;
    let startTime = Date.now();
    let correctCount = 0;
    let totalAnswered = 0;
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let isFavoriteMode = false;

    document.getElementById('excelFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        questions = json.slice(1).map(row => ({
          id: row[0],
          content: row[1],
          options: [row[2], row[3], row[4], row[5]],
          answer: row[6],
          explanation: row[7],
        })).filter(q => q.content);
        localStorage.setItem('quizData', JSON.stringify(questions));
        document.getElementById('controls').classList.remove('hidden');
        nextQuestion();
        setInterval(updateTimer, 1000);
      };
      reader.readAsArrayBuffer(file);
    });

    function nextQuestion() {
      document.getElementById('explanationBox').innerHTML = '';
      const source = isFavoriteMode ? favorites.map(i => questions.find(q => q.id === i)) : questions;
      if (!source.length) return alert('没有题目了！');
      currentIndex = Math.floor(Math.random() * source.length);
      showQuestion(source[currentIndex]);
    }

    function showQuestion(q) {
      const box = document.getElementById('questionBox');
      box.classList.remove('hidden');
      box.innerHTML = `<div><strong>题目:</strong> ${q.content}</div>` +
        q.options.map((opt, i) => `<div class="option" onclick="checkAnswer(this, '${String.fromCharCode(65+i)}', '${q.answer}', \
        '${q.explanation.replace(/'/g, "&quot;")}')">${String.fromCharCode(65+i)}. ${opt}</div>`).join('') +
        `<div><button onclick="toggleFavorite(${q.id})">${favorites.includes(q.id) ? '取消收藏' : '收藏'}</button></div>`;
    }

    function checkAnswer(elem, choice, answer, explanation) {
      if (elem.parentNode.querySelector('.option.correct, .option.wrong')) return;
      const options = elem.parentNode.querySelectorAll('.option');
      options.forEach(opt => {
        if (opt.textContent.startsWith(answer)) opt.classList.add('correct');
        else if (opt === elem) opt.classList.add('wrong');
      });
      if (choice === answer) correctCount++;
      totalAnswered++;
      updateAccuracy();
      document.getElementById('explanationBox').innerHTML = '<strong>解析:</strong> ' + explanation;
    }

    function updateTimer() {
      const now = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById('timer').innerText = `用时: ${now}秒`;
    }

    function updateAccuracy() {
      const rate = totalAnswered ? ((correctCount / totalAnswered) * 100).toFixed(1) : 0;
      document.getElementById('accuracy').innerText = `正确率: ${rate}%`;
    }

    function toggleFavorite(id) {
      if (favorites.includes(id)) favorites = favorites.filter(f => f !== id);
      else favorites.push(id);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      nextQuestion();
    }

    function toggleFavorites() {
      isFavoriteMode = !isFavoriteMode;
      nextQuestion();
    }

    // 自动加载本地缓存的数据
    const saved = localStorage.getItem('quizData');
    if (saved) {
      questions = JSON.parse(saved);
      document.getElementById('controls').classList.remove('hidden');
      nextQuestion();
      setInterval(updateTimer, 1000);
    }
  </script>
</body>
</html>
