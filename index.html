<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>词义辨析题库</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
    #quiz-container, #stats, #bookmarks { margin-top: 20px; }
    .question-box { padding: 15px; border-radius: 10px; background: #fff; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .option { padding: 10px; margin: 5px 0; background-color: #eee; border-radius: 5px; cursor: pointer; }
    .option.correct { background-color: #c8f7c5; }
    .option.incorrect { background-color: #f7c5c5; }
    button { margin-top: 10px; }
    #stats { margin-top: 10px; }
    #home, #quiz-section, #bookmarks-section { display: none; }
  </style>
</head>
<body>
  <h1>词义辨析刷题</h1>
  <div id="home">
    <input type="file" id="file-input" accept=".xlsx">
    <button onclick="startQuiz()">开始答题</button>
    <button onclick="showBookmarks()">查看收藏题</button>
  </div>
  <div id="quiz-section">
    <div id="stats"></div>
    <div id="timer">时间：0秒</div>
    <div id="quiz-container"></div>
    <button onclick="nextQuestion()">下一题</button>
    <button onclick="bookmarkCurrent()">收藏题目</button>
    <button onclick="goHome()">返回首页</button>
  </div>
  <div id="bookmarks-section">
    <h2>收藏题目</h2>
    <div id="bookmarks"></div>
    <button onclick="goHome()">返回首页</button>
  </div>

  <script>
    let questions = [], current = 0, correctCount = 0, total = 0, timer = 0, interval;
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    let savedData = localStorage.getItem('savedExcel');

    if (savedData) loadWorkbook(XLSX.read(savedData, {type: 'base64'}));
    else document.getElementById('home').style.display = 'block';

    document.getElementById('file-input').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        localStorage.setItem('savedExcel', btoa(evt.target.result));
        const workbook = XLSX.read(evt.target.result, { type: 'binary' });
        loadWorkbook(workbook);
      };
      reader.readAsBinaryString(e.target.files[0]);
    });

    function loadWorkbook(workbook) {
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet);
      questions = data.map(row => ({
        question: row['题干'],
        options: [row['选项A'], row['选项B'], row['选项C'], row['选项D']],
        answer: row['正确答案'],
        explanation: row['解析'],
        id: row['题号']
      }));
      shuffleArray(questions);
      document.getElementById('home').style.display = 'block';
    }

    function startQuiz() {
      document.getElementById('home').style.display = 'none';
      document.getElementById('quiz-section').style.display = 'block';
      correctCount = 0;
      total = 0;
      timer = 0;
      current = 0;
      clearInterval(interval);
      interval = setInterval(() => {
        timer++;
        document.getElementById('timer').innerText = `时间：${timer}秒`;
      }, 1000);
      nextQuestion();
    }

    function nextQuestion() {
      if (current >= questions.length) return alert('题目已做完！');
      const q = questions[current];
      const container = document.getElementById('quiz-container');
      container.innerHTML = `<div class="question-box"><strong>Q${q.id}</strong>: ${q.question}<br><br>` +
        q.options.map((opt, i) => `<div class="option" onclick="selectOption(this, '${String.fromCharCode(65+i)}', '${q.answer}', \
        '${q.explanation.replace(/'/g, "\'")}')">${String.fromCharCode(65+i)}. ${opt}</div>`).join('') +
        `</div>`;
      current++;
    }

    function selectOption(elem, selected, answer, explanation) {
      total++;
      if (selected === answer) {
        elem.classList.add('correct');
        correctCount++;
      } else {
        elem.classList.add('incorrect');
        Array.from(elem.parentNode.querySelectorAll('.option')).forEach(e => {
          if (e.innerText.startsWith(answer)) e.classList.add('correct');
        });
      }
      document.getElementById('stats').innerText = `共答题：${total}，正确：${correctCount}，正确率：${((correctCount/total)*100).toFixed(1)}%`;
      const explanationBox = document.createElement('div');
      explanationBox.innerHTML = `<strong>解析：</strong>${explanation}`;
      elem.parentNode.appendChild(explanationBox);
      Array.from(elem.parentNode.querySelectorAll('.option')).forEach(e => e.onclick = null);
    }

    function bookmarkCurrent() {
      const q = questions[current - 1];
      if (!bookmarks.some(b => b.id === q.id)) bookmarks.push(q);
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      alert('已收藏');
    }

    function showBookmarks() {
      document.getElementById('home').style.display = 'none';
      document.getElementById('bookmarks-section').style.display = 'block';
      const container = document.getElementById('bookmarks');
      container.innerHTML = '';
      if (bookmarks.length === 0) container.innerText = '暂无收藏';
      bookmarks.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'question-box';
        div.innerHTML = `<strong>Q${q.id}</strong>: ${q.question}<br><br>` +
          q.options.map((opt, j) => `${String.fromCharCode(65+j)}. ${opt}`).join('<br>') +
          `<br><strong>正确答案：</strong>${q.answer}<br><strong>解析：</strong>${q.explanation}`;
        container.appendChild(div);
      });
    }

    function goHome() {
      document.getElementById('home').style.display = 'block';
      document.getElementById('quiz-section').style.display = 'none';
      document.getElementById('bookmarks-section').style.display = 'none';
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</body>
</html>
