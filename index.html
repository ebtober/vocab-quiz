<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¯ä¹‰è¾¨æ Quiz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 2em auto;
      padding: 1em;
    }
    .question-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
    }
    .options label {
      display: block;
      margin: 0.5em 0;
    }
    .correct { color: green; }
    .wrong { color: red; }
    button { margin-top: 1em; }
    #stats { margin-top: 1em; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>è¯ä¹‰è¾¨æ Quiz</h1>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />
  <div id="quizContainer"></div>
  <div id="stats"></div>

  <script>
    let quizData = [];
    let currentIndex = 0;
    let correctCount = 0;
    let startTime = null;

    function parseExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        localStorage.setItem('quizData', JSON.stringify(json));
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function renderQuestion() {
      if (currentIndex >= quizData.length) {
        document.getElementById('quizContainer').innerHTML = '<h3>å·²å®Œæˆï¼ğŸ‰</h3>';
        return;
      }

      const q = quizData[currentIndex];
      const container = document.getElementById('quizContainer');
      container.innerHTML = `
        <div class="question-box">
          <div><strong>é¢˜å¹² ${currentIndex + 1}ï¼š</strong> ${q['é¢˜å¹²']}</div>
          <div class="options">
            ${['é€‰é¡¹A', 'é€‰é¡¹B', 'é€‰é¡¹C', 'é€‰é¡¹D'].map(letter => `
              <label><input type="radio" name="option" value="${letter}" /> ${letter}. ${q[letter]}</label>
            `).join('')}
          </div>
          <button onclick="submitAnswer()">æäº¤</button>
          <button onclick="toggleFavorite(${currentIndex})">â­ æ”¶è—</button>
          <div id="feedback"></div>
        </div>
      `;
    }

    function submitAnswer() {
      const q = quizData[currentIndex];
      const selected = document.querySelector('input[name="option"]:checked');
      const feedback = document.getElementById('feedback');
      if (!selected) {
        feedback.innerHTML = '<span class="wrong">è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚</span>';
        return;
      }
      if (selected.value === q['æ­£ç¡®ç­”æ¡ˆ']) {
        feedback.innerHTML = '<span class="correct">âœ… æ­£ç¡®ï¼</span>';
        correctCount++;
      } else {
        feedback.innerHTML = `<span class="wrong">âŒ é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${q['æ­£ç¡®ç­”æ¡ˆ']}</span>`;
      }
      feedback.innerHTML += `<div>è§£æï¼š${q['è§£æ'] || 'æ— '}</div>`;
      setTimeout(() => {
        currentIndex++;
        renderQuestion();
        updateStats();
      }, 2000);
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const elapsed = startTime ? (Date.now() - startTime) / 1000 : 0;
      stats.innerHTML = `
        <div>å½“å‰è¿›åº¦ï¼š${currentIndex}/${quizData.length}</div>
        <div>æ­£ç¡®æ•°ï¼š${correctCount}</div>
        <div>æ­£ç¡®ç‡ï¼š${((correctCount / currentIndex) * 100).toFixed(1)}%</div>
        <div>è€—æ—¶ï¼š${elapsed.toFixed(1)} ç§’</div>
      `;
    }

    function toggleFavorite(index) {
      let fav = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (!fav.includes(index)) fav.push(index);
      else fav = fav.filter(i => i !== index);
      localStorage.setItem('favorites', JSON.stringify(fav));
      alert(fav.includes(index) ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—');
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        parseExcel(file, data => {
          quizData = shuffle(data);
          currentIndex = 0;
          correctCount = 0;
          startTime = Date.now();
          renderQuestion();
          updateStats();
        });
      }
    });

    // è‡ªåŠ¨åŠ è½½ç¼“å­˜çš„ quizDataï¼ˆå¦‚æœæœ‰ï¼‰
    const cached = localStorage.getItem('quizData');
    if (cached) {
      quizData = shuffle(JSON.parse(cached));
      currentIndex = 0;
      correctCount = 0;
      startTime = Date.now();
      renderQuestion();
      updateStats();
    }
  </script>
</body>
</html>
