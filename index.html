<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>词义辨析题库</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    .question-box { margin-bottom: 20px; }
    .option { border: 1px solid #ccc; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 6px; }
    .option:hover { background-color: #f0f0f0; }
    .correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
    .wrong { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
    .controls { margin-top: 20px; }
    #favorites-btn { margin-left: 10px; }
    #timer, #accuracy { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>词义辨析题库</h1>
  <input type="file" id="fileInput" accept=".xlsx" />
  <div id="timer">计时：0秒</div>
  <div id="accuracy">正确率：0%</div>
  <div class="question-box" id="quizBox"></div>
  <div class="controls">
    <button onclick="nextQuestion()">下一题</button>
    <button id="favorites-btn" onclick="toggleFavorite()">收藏</button>
    <button onclick="viewFavorites()">查看收藏册</button>
  </div>
  <div id="explanation"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let questions = [],
        currentQuestion = {},
        currentIndex = 0,
        correctCount = 0,
        totalCount = 0,
        favorites = JSON.parse(localStorage.getItem('favorites') || '[]'),
        startTime = Date.now();

    const quizBox = document.getElementById("quizBox");
    const explanationBox = document.getElementById("explanation");

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        json.shift(); // remove header row
        questions = json.map(row => ({
          id: row[0], question: row[1], options: row.slice(2, 6), answer: row[6].toUpperCase(), explanation: row[7] || ""
        }));
        localStorage.setItem('quizData', JSON.stringify(questions));
        nextQuestion();
        startTimer();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function startTimer() {
      setInterval(() => {
        const seconds = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").textContent = `计时：${seconds}秒`;
      }, 1000);
    }

    function nextQuestion() {
      if (questions.length === 0) return;
      currentIndex = Math.floor(Math.random() * questions.length);
      currentQuestion = questions[currentIndex];
      showQuestion();
    }

    function showQuestion() {
      explanationBox.textContent = "";
      quizBox.innerHTML = `<div><strong>题目：</strong>${currentQuestion.question}</div>`;
      currentQuestion.options.forEach((opt, index) => {
        const letter = String.fromCharCode(65 + index);
        const div = document.createElement("div");
        div.textContent = `${letter}. ${opt}`;
        div.classList.add("option");
        div.onclick = () => checkAnswer(div, letter);
        quizBox.appendChild(div);
      });
      updateFavoriteBtn();
    }

    function checkAnswer(div, selected) {
      const options = document.querySelectorAll(".option");
      options.forEach(opt => opt.onclick = null); // disable clicking again
      totalCount++;
      if (selected === currentQuestion.answer) {
        correctCount++;
        div.classList.add("correct");
      } else {
        div.classList.add("wrong");
        options.forEach(opt => {
          if (opt.textContent.startsWith(currentQuestion.answer + '.')) {
            opt.classList.add("correct");
          }
        });
      }
      document.getElementById("accuracy").textContent = `正确率：${Math.round((correctCount / totalCount) * 100)}%`;
      explanationBox.textContent = `解析：${currentQuestion.explanation}`;
    }

    function toggleFavorite() {
      const id = currentQuestion.id;
      const exists = favorites.find(q => q.id === id);
      if (exists) {
        favorites = favorites.filter(q => q.id !== id);
      } else {
        favorites.push(currentQuestion);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoriteBtn();
    }

    function updateFavoriteBtn() {
      const id = currentQuestion.id;
      const btn = document.getElementById("favorites-btn");
      btn.textContent = favorites.find(q => q.id === id) ? "取消收藏" : "收藏";
    }

    function viewFavorites() {
      if (favorites.length === 0) return alert("暂无收藏题目");
      questions = [...favorites];
      nextQuestion();
    }

    // 加载保存的题库（如果有）
    window.onload = () => {
      const saved = localStorage.getItem("quizData");
      if (saved) {
        questions = JSON.parse(saved);
        nextQuestion();
        startTimer();
      }
    }
  </script>
</body>
</html>
